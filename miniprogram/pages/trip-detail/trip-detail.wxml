<!--pages/trip-detail/trip-detail.wxml-->
<view class="container aurora-page" bindtap="cancelMove">
  <view class="hero">
    <image src="{{tripInfo.coverUrl || 'https://images.unsplash.com/photo-1431274172761-fca41d930114?q=80&w=1080'}}" mode="aspectFill" class="hero-bg" />
    <view class="hero-overlay"></view>
    <view class="top-bar" style="padding-top: {{statusBarHeight}}px">
      <view class="icon-btn glass-strong" catchtap="goBack" hover-class="pressed">â†</view>
      <view class="icon-btn glass-strong" catchtap="generatePoster" hover-class="pressed">ğŸ“¤</view>
    </view>
    <view class="hero-info">
      <text class="hero-title">{{tripInfo.title || 'æˆ‘çš„è·¯ä¹¦'}}</text>
      <view class="badges">
        <view class="badge glass-strong">ğŸ“ {{tripInfo.city || 'æœªçŸ¥'}}</view>
        <view class="badge glass-strong">ğŸ“… {{tripInfo.days || 0}}å¤©</view>
        <view class="badge glass-strong">ğŸ’° Â¥{{(tripInfo.meta && tripInfo.meta.totalCost) || 0}}</view>
      </view>
    </view>
  </view>

  <view class="timeline-section">
    <view class="timeline-line"></view>

    <view class="blocks-list">
      <block wx:for="{{blocks}}" wx:key="id">
        <view class="move-target {{movingBlockId ? 'show' : ''}}" wx:if="{{movingBlockId && movingBlockId !== item.id}}" bindtap="onMoveTargetClick" data-index="{{index}}">
          <view class="move-indicator glass">ğŸ‘‡ ç§»åŠ¨åˆ°è¿™é‡Œ</view>
        </view>

        <view class="insert-zone" wx:if="{{editMode && !movingBlockId}}" catchtap="onInsert" data-index="{{index}}">
          <view class="plus-btn glass-strong">ï¼‹</view>
        </view>

        <view class="block-row type-{{item.type}} {{movingBlockId === item.id ? 'moving' : ''}}" bindlongpress="onBlockLongPress" data-block-id="{{item.id}}">
          <view class="node-col">
            <view wx:if="{{item.type === 'day-divider'}}" class="node-day glass-strong">ğŸ“…</view>
            <view wx:elif="{{item.type === 'transport'}}" class="node-dot trans"></view>
            <view wx:else class="node-dot poi glass"></view>
          </view>

          <view class="content-col">
            <view wx:if="{{item.type === 'day-divider'}}" class="day-header glass-strong">
              <text class="day-label">{{item.content.label}}</text>
              <text class="day-date" wx:if="{{item.content.date}}">{{item.content.date}}</text>
            </view>
            <view wx:else class="block-card glass-strong">
              <block-renderer
                block="{{item}}"
                editMode="{{editMode}}"
                bind:update="onBlockUpdate"
                bind:delete="onBlockDelete"
                bind:navigate="onBlockNavigate"
              />
            </view>
          </view>
        </view>
      </block>

      <view class="move-target tail {{movingBlockId ? 'show' : ''}}" wx:if="{{movingBlockId}}" bindtap="onMoveTargetClick" data-index="{{blocks.length}}">
        <view class="move-indicator glass">ğŸ‘‡ ç§»åŠ¨åˆ°æœ«å°¾</view>
      </view>

      <view class="append-zone" wx:if="{{editMode && !movingBlockId}}" catchtap="onAppendBlock">
        <view class="append-btn glass">ï¼‹ æ·»åŠ èŠ‚ç‚¹</view>
      </view>

      <view class="empty-blocks" wx:if="{{blocks.length === 0}}">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">è¿˜æ²¡æœ‰å†…å®¹</text>
        <text class="empty-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è§„åˆ’</text>
      </view>
    </view>

    <view class="footer-spacer"></view>
  </view>

  <view class="bottom-bar-container">
    <view class="bottom-bar glass-strong">
      <view class="tool-btn {{editMode ? 'active' : ''}}" catchtap="toggleEditMode" hover-class="pressed">
        <text class="icon">âœï¸</text>
        <text>{{editMode ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
      </view>
      <view class="divider"></view>
      <view class="tool-btn" catchtap="openMapView" hover-class="pressed">
        <text class="icon">ğŸ—ºï¸</text>
      </view>
    </view>
  </view>

  <view class="add-drawer {{showAddDrawer ? 'show' : ''}}" catchtap="hideAddDrawer">
    <view class="drawer-panel" catchtap="stopPropagation">
      <view class="drawer-header">æ·»åŠ æ¨¡å—</view>
      <view class="drawer-grid">
        <view class="drawer-item" catchtap="addBlock" data-type="poi">ğŸ“ åœ°ç‚¹</view>
        <view class="drawer-item" catchtap="addBlock" data-type="transport">ğŸš— äº¤é€š</view>
        <view class="drawer-item" catchtap="addBlock" data-type="text">ğŸ“ å¤‡æ³¨</view>
        <view class="drawer-item" catchtap="addBlock" data-type="checklist">ğŸ“‹ æ¸…å•</view>
        <view class="drawer-item" catchtap="addBlock" data-type="image">ğŸ“· å›¾ç‰‡</view>
        <view class="drawer-item" catchtap="addBlock" data-type="day-divider">ğŸ“… æ—¥æœŸ</view>
      </view>
    </view>
  </view>

  <!-- Hidden canvas for poster generation -->
  <canvas canvas-id="posterCanvas" class="poster-canvas"></canvas>

</view>