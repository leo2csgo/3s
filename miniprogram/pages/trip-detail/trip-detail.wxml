<!--pages/trip-detail/trip-detail.wxml-->
<view class="container" style="background: {{currentBg}}" bindtap="cancelMove">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="nav-bar {{scrollTop > 10 ? 'glass' : ''}}" style="padding-top: {{statusBarHeight}}px">
    <view class="nav-content">
      <view class="nav-back" bindtap="goBack">
        <text class="back-icon">â†</text>
      </view>
      <text class="nav-title">{{tripInfo.title || 'è·¯ä¹¦è¯¦æƒ…'}}</text>
      <view class="nav-actions">
        <text class="nav-icon" bindtap="showMoreActions">â‹®</text>
      </view>
    </view>
  </view>

  <!-- Hero Section -->
  <view class="hero-section" style="padding-top: {{statusBarHeight + 44}}px">
    <view class="hero-bg" wx:if="{{tripInfo.coverUrl}}">
      <image class="hero-cover" src="{{tripInfo.coverUrl}}" mode="aspectFill"></image>
      <view class="hero-gradient"></view>
    </view>
    <view class="hero-content">
      <view class="hero-badges">
        <view class="badge">{{tripInfo.city || 'æœªçŸ¥åŸå¸‚'}}</view>
        <view class="badge">{{tripInfo.days || 0}} Days</view>
        <view class="badge">{{tripInfo.intent || 'æ—…è¡Œ'}}</view>
      </view>
      <text class="hero-title">{{tripInfo.title || 'æˆ‘çš„è·¯ä¹¦'}}</text>
      <view class="hero-meta">
        <text>é¢„ç®— Â¥{{tripInfo.meta.totalCost || 0}}</text>
        <text class="dot">Â·</text>
        <text>{{blocks.length}} ä¸ªèŠ‚ç‚¹</text>
      </view>
      <view class="route-overview" wx:if="{{dayOverview && dayOverview.length}}">
        <block wx:for="{{dayOverview}}" wx:key="index">
          <view class="route-chip">
            <view class="route-dot" style="background: {{item.color}}"></view>
            <text>D{{item.index}} Â· {{item.count}}</text>
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- Block åˆ—è¡¨åŒºåŸŸ -->
  <scroll-view class="block-scroll" scroll-y="{{true}}" enhanced="{{true}}" bindscroll="onScrollView">
    <view class="timeline-canvas">
      <view class="timeline-guide-line"></view>

      <!-- éå† blocks -->
      <block wx:for="{{blocks}}" wx:key="id">
        <!-- ç§»åŠ¨ç›®æ ‡åŒºï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹å‰ï¼ˆä»…ç§»åŠ¨æ¨¡å¼å±•ç¤ºï¼‰ -->
        <view
          class="move-target {{movingBlockId ? 'show' : ''}}"
          wx:if="{{movingBlockId && movingBlockId !== item.id}}"
          bindtap="onMoveTargetClick"
          data-index="{{index}}"
        >
          <view class="move-indicator">ğŸ‘‡ ç§»åŠ¨åˆ°è¿™é‡Œ</view>
        </view>

        <!-- æ’å…¥çƒ­åŒºï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹å‰ï¼ˆéç§»åŠ¨æ¨¡å¼ï¼‰ -->
        <view class="insert-zone" wx:if="{{editMode && !movingBlockId}}" bindtap="onInsert" data-index="{{index}}">
          <view class="plus-btn">+</view>
        </view>

        <view class="timeline-node type-{{item.type}} {{movingBlockId === item.id ? 'moving' : ''}}" bindlongpress="onBlockLongPress" data-block-id="{{item.id}}">
          <view class="node-left">
            <view wx:if="{{item.type === 'day-divider'}}" class="dot-day">ğŸ“…</view>
            <view wx:elif="{{item.type === 'transport'}}" class="dot-trans">ğŸš—</view>
            <view wx:else class="dot-poi"></view>
          </view>
          <view class="node-body">
            <block-renderer
              block="{{item}}"
              editMode="{{editMode}}"
              bind:navigate="onBlockNavigate"
              bind:delete="onBlockDelete"
              bind:edit="onBlockEdit"
              bind:textchange="onBlockTextChange"
              bind:update="onBlockUpdate"
            />
          </view>
        </view>
      </block>

      <!-- å°¾éƒ¨ç§»åŠ¨ç›®æ ‡åŒºï¼ˆç§»åŠ¨æ¨¡å¼ï¼‰ -->
      <view
        class="move-target tail {{movingBlockId ? 'show' : ''}}"
        wx:if="{{movingBlockId}}"
        bindtap="onMoveTargetClick"
        data-index="{{blocks.length}}"
      >
        <view class="move-indicator">ğŸ‘‡ ç§»åŠ¨åˆ°æœ«å°¾</view>
      </view>

      <!-- æœ«å°¾è¿½åŠ åŒºï¼ˆéç§»åŠ¨æ¨¡å¼ï¼‰ -->
      <view class="append-zone" bindtap="onAppendBlock" wx:if="{{editMode && !movingBlockId}}">
        <text>+ æ·»åŠ è¡Œç¨‹èŠ‚ç‚¹</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-blocks" wx:if="{{blocks.length === 0}}">
        <text class="empty-icon">ğŸ“</text>
        <text class="empty-text">è¿˜æ²¡æœ‰å†…å®¹</text>
        <text class="empty-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è§„åˆ’</text>
      </view>

      <view class="footer-spacer"></view>
    </view>
  </scroll-view>

  <!-- ç»Ÿä¸€åº•éƒ¨å·¥å…·æ ï¼ˆGlass Barï¼‰ -->
  <view class="bottom-toolbar glass-bar">
    <view class="tool-btn" bindtap="toggleEditMode">
      <text class="icon">{{editMode ? 'âœ“' : 'âœ'}}</text>
      <text>{{editMode ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
    </view>
    <view class="tool-btn highlight" bindtap="openMapView">
      <text class="icon">ğŸ—ºï¸</text>
      <text>åœ°å›¾</text>
    </view>
    <view class="tool-btn" bindtap="generatePoster">
      <text class="icon">ğŸ“¤</text>
      <text>åˆ†äº«</text>
    </view>
  </view>

  <!-- æ·»åŠ æ¨¡å—åŠå±èœå• -->
  <view class="add-drawer {{showAddDrawer ? 'show' : ''}}" catchtap="hideAddDrawer">
    <view class="drawer-content" catchtap="stopPropagation">
      <view class="drawer-header">
        <text class="drawer-title">æ·»åŠ æ¨¡å—</text>
        <text class="drawer-close" bindtap="hideAddDrawer">Ã—</text>
      </view>
      <view class="drawer-grid">
        <view class="drawer-item" bindtap="addBlock" data-type="poi">
          <text class="item-icon">ğŸ“</text>
          <text class="item-name">åœ°ç‚¹</text>
        </view>
        <view class="drawer-item" bindtap="addBlock" data-type="text">
          <text class="item-icon">ğŸ“</text>
          <text class="item-name">å¤‡æ³¨</text>
        </view>
        <view class="drawer-item" bindtap="addBlock" data-type="transport">
          <text class="item-icon">ğŸš—</text>
          <text class="item-name">äº¤é€š</text>
        </view>
        <view class="drawer-item" bindtap="addBlock" data-type="image">
          <text class="item-icon">ğŸ“·</text>
          <text class="item-name">å›¾ç‰‡</text>
        </view>
        <view class="drawer-item" bindtap="addBlock" data-type="day-divider">
          <text class="item-icon">ğŸ“…</text>
          <text class="item-name">æ—¥æœŸ</text>
        </view>
        <view class="drawer-item" bindtap="addFromFavorites">
          <text class="item-icon">â­</text>
          <text class="item-name">æ”¶è—</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Hidden canvas for poster generation -->
  <canvas canvas-id="posterCanvas" class="poster-canvas"></canvas>

</view>