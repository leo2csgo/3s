<view class="container">
  <!-- æ ‡é¢˜åŒº -->
  <view class="header">
    <text class="title">3ç§’å‡ºå¡</text>
    <text class="subtitle">æ™ºèƒ½ç”Ÿæˆä½ çš„ä¸“å±è¡Œç¨‹</text>
  </view>

  <!-- é€‰æ‹©åŒº -->
  <view class="selector-section">
    <!-- åŸå¸‚é€‰æ‹© -->
    <view class="selector-item">
      <text class="label">ğŸ“ é€‰æ‹©åŸå¸‚</text>
      <picker mode="selector" range="{{cities}}" value="{{cityIndex}}" bindchange="onCityChange">
        <view class="picker">
          {{cities[cityIndex]}}
        </view>
      </picker>
    </view>

    <!-- å¤©æ•°é€‰æ‹© -->
    <view class="selector-item">
      <text class="label">ğŸ“… å‡ºè¡Œå¤©æ•°</text>
      <picker mode="selector" range="{{days}}" value="{{dayIndex}}" bindchange="onDayChange">
        <view class="picker">
          {{days[dayIndex]}}å¤©
        </view>
      </picker>
    </view>

    <!-- å‡ºè¡Œç›®çš„ -->
    <view class="selector-item">
      <text class="label">ğŸ¯ å‡ºè¡Œç›®çš„</text>
      <view class="intent-tags">
        <view 
          wx:for="{{intents}}" 
          wx:key="index" 
          class="tag {{intentIndex === index ? 'tag-active' : ''}}"
          bindtap="onIntentChange"
          data-index="{{index}}">
          {{item}}
        </view>
      </view>
    </view>
  </view>

  <!-- ç”ŸæˆæŒ‰é’® -->
  <button class="generate-btn" bindtap="generateCard" loading="{{loading}}">
    {{loading ? 'æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆ...' : '3ç§’å‡ºå¡'}}
  </button>

  <!-- å¡ç‰‡å±•ç¤ºåŒº - å±…ä¸­å®¹å™¨ -->
  <view class="card-display-container" wx:if="{{planData}}">

    <!-- ç¼–è¾‘æ¨¡å¼ï¼šDOMç»“æ„ -->
    <view class="card-display" id="card-dom" wx:if="{{!generatedImagePath}}">
      <!-- èƒŒæ™¯å±‚ -->
      <image class="poster-bg" src="{{currentBgImage}}" mode="aspectFill" wx:if="{{currentBgImage}}"></image>
      <view class="poster-bg-gradient" wx:else style="background: linear-gradient(135deg, {{backgrounds[bgIndex].color1}} 0%, {{backgrounds[bgIndex].color2}} 100%);"></view>

      <!-- å†…å®¹å±‚ - æ¯›ç»ç’ƒæ•ˆæœ -->
      <view class="poster-content-wrapper">
        <!-- æµ·æŠ¥å¤´éƒ¨ -->
        <view class="poster-header">
          <text class="poster-title">âœˆï¸ {{cities[cityIndex]}} Â· {{days[dayIndex]}}å¤©ä¹‹æ—…</text>
          <text class="poster-subtitle">{{intents[intentIndex]}} Â· æˆ‘çš„ä¸“å±è¡Œç¨‹</text>
        </view>

        <!-- è¡Œç¨‹åˆ—è¡¨ -->
        <view class="itinerary-list">
          <block wx:for="{{planData.days}}" wx:key="day" wx:for-item="dayItem" wx:for-index="dIndex">
            <!-- æ—¥æœŸæ ‡é¢˜ -->
            <view class="day-header">
              <view class="day-badge">Day {{dayItem.day}}</view>
              <text class="day-date">{{dayItem.date}}</text>
            </view>

            <!-- æ´»åŠ¨åˆ—è¡¨ -->
            <view class="activity-item" wx:for="{{dayItem.activities}}" wx:key="name" wx:for-item="act" wx:for-index="aIndex">
              <view class="activity-time-row">
                <text class="time-tag">{{act.time || 'å…¨å¤©'}}</text>
                <view class="activity-cost">ğŸ’° Â¥{{act.cost}}</view>
              </view>

              <view class="activity-main">
                <view class="activity-name-row">
                  <text class="activity-name">{{act.name}}</text>
                  <view class="location-btn" bindtap="openMap" data-location="{{act.name}}" data-address="{{act.description}}">
                    <view class="nav-icon-bg">
                      <text class="loc-icon">â†—</text>
                    </view>
                    <text class="loc-text">å»è¿™é‡Œ</text>
                  </view>
                </view>

                <textarea
                  class="activity-desc-input"
                  auto-height
                  maxlength="200"
                  placeholder="ç‚¹å‡»ç¼–è¾‘æ´»åŠ¨æè¿°..."
                  value="{{act.description}}"
                  data-day-index="{{dIndex}}"
                  data-act-index="{{aIndex}}"
                  bindinput="onActivityEdit"
                ></textarea>

                <view class="activity-duration">â± {{act.duration}}å°æ—¶</view>
              </view>
            </view>
          </block>
        </view>

        <!-- è¡Œå‰å‡†å¤‡æ¸…å• -->
        <view class="section-box checklist-section" wx:if="{{checkList.length > 0}}">
          <view class="section-title">
            <text class="section-icon">ğŸ’</text>
            <text>è¡Œå‰å‡†å¤‡ Â· {{intents[intentIndex]}}ç‰ˆ</text>
          </view>
          <view class="checklist-grid">
            <view
              class="checklist-item {{item.checked ? 'checked' : ''}}"
              wx:for="{{checkList}}"
              wx:key="text"
              bindtap="toggleCheck"
              data-index="{{index}}"
            >
              <view class="checkbox">
                <text wx:if="{{item.checked}}">âœ“</text>
              </view>
              <text class="check-text">{{item.text}}</text>
            </view>
          </view>
        </view>

        <!-- æ—…è¡Œå°è´´å£« -->
        <view class="section-box tips-section" wx:if="{{travelTips}}">
          <view class="section-title">
            <text class="section-icon">ğŸ’¡</text>
            <text>æ—…è¡Œå°è´´å£«</text>
          </view>
          <view class="tips-content">
            <text>{{travelTips}}</text>
          </view>
        </view>

        <!-- æµ·æŠ¥åº•éƒ¨ - åµŒå…¥äºŒç»´ç  -->
        <view class="poster-footer">
          <view class="qr-section">
            <view class="qr-desc">
              <text class="qr-title">æ‰«ç è·å–åŒæ¬¾è¡Œç¨‹</text>
              <text class="qr-sub">AI æ™ºèƒ½å®šåˆ¶ Â· 3ç§’å‡ºå¡</text>
            </view>
            <view class="qr-container">
              <image class="qr-image" src="{{qrCodeUrl || '/images/3s.jpg'}}" mode="aspectFit"></image>
            </view>
          </view>
          <text class="total-cost">ğŸ’° é¢„è®¡æ€»è´¹ç”¨ï¼šÂ¥{{planData.total_cost}}</text>
        </view>
      </view>

      <!-- ç¼–è¾‘æ¨¡å¼æ‚¬æµ®æŒ‰é’® -->
      <view class="action-buttons-floating">
        <button class="action-btn-float" bindtap="generatePoster">ğŸ“¸ ç”Ÿæˆåˆ†äº«æµ·æŠ¥</button>
        <button class="action-btn-float theme-btn" bindtap="showBgSelector">ğŸ¨ æ¢èƒŒæ™¯</button>
        <button class="action-btn-float" bindtap="regenerate">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
      </view>
    </view>

    <!-- å›¾ç‰‡æ¨¡å¼ï¼šæœ€ç»ˆæµ·æŠ¥å±•ç¤º -->
    <view class="result-image-wrapper" wx:if="{{generatedImagePath}}">
      <image
        src="{{generatedImagePath}}"
        class="final-poster-image"
        mode="widthFix"
        show-menu-by-longpress="{{true}}"
        bindlongpress="showImageMenu"
      ></image>

      <view class="image-actions">
        <button class="re-edit-btn" bindtap="backToEdit">âœï¸ ä¿®æ”¹å†…å®¹</button>
        <button class="save-btn" bindtap="saveToAlbum">ğŸ’¾ ä¿å­˜åˆ°ç›¸å†Œ</button>
      </view>

      <view class="share-tip">
        <text>ğŸ’¡ é•¿æŒ‰å›¾ç‰‡å¯ç›´æ¥åˆ†äº«åˆ°å¾®ä¿¡</text>
        <text>æ‰«æå›¾ä¸­äºŒç»´ç ï¼Œæœ‹å‹ä¹Ÿèƒ½è·å¾—åŒæ¬¾è¡Œç¨‹</text>
      </view>
    </view>

  </view>

  <!-- éšè—çš„Canvasç”¨äºç»˜åˆ¶å›¾ç‰‡ -->
  <canvas canvas-id="cardCanvas" id="cardCanvas" class="hidden-canvas" style="width: 750px; height: {{canvasHeight || 1334}}px;"></canvas>

  <!-- ä¸»é¢˜é€‰æ‹©å™¨ -->
  <view class="theme-selector-overlay" wx:if="{{showThemeSelector}}" bindtap="hideThemeSelector">
    <view class="theme-selector" catchtap="{{null}}">
      <view class="theme-selector-title">é€‰æ‹©ä¸»é¢˜é…è‰²</view>
      <view class="theme-list-new">
        <view
          wx:for="{{themes}}"
          wx:key="index"
          class="theme-card {{themeIndex === index ? 'active' : ''}}"
          bindtap="selectTheme"
          data-index="{{index}}">
          <view class="theme-gradient" style="background: linear-gradient(135deg, {{item.bg1}} 0%, {{item.bg2}} 100%);"></view>
          <view class="theme-info">
            <text class="theme-name-new">{{item.name}}</text>
            <view wx:if="{{themeIndex === index}}" class="theme-check-new">âœ“ ä½¿ç”¨ä¸­</view>
          </view>
        </view>
      </view>
      <button class="theme-close-btn" bindtap="hideThemeSelector">å…³é—­</button>
    </view>
  </view>

  <!-- èƒŒæ™¯é€‰æ‹©å™¨ -->
  <view class="theme-selector-overlay" wx:if="{{showBgSelector}}" bindtap="hideBgSelector">
    <view class="theme-selector" catchtap="{{null}}">
      <view class="theme-selector-title">é€‰æ‹©å¡ç‰‡èƒŒæ™¯</view>
      <view class="theme-list-new">
        <!-- æ¸å˜èƒŒæ™¯ -->
        <view
          class="theme-card {{bgIndex === 0 ? 'active' : ''}}"
          bindtap="selectBackground"
          data-index="0">
          <view class="theme-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></view>
          <view class="theme-info">
            <text class="theme-name-new">ç´«æ¢¦æ¸å˜</text>
            <view wx:if="{{bgIndex === 0}}" class="theme-check-new">âœ“ ä½¿ç”¨ä¸­</view>
          </view>
        </view>
        <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
        <view
          class="theme-card {{bgIndex === 1 ? 'active' : ''}}"
          bindtap="selectBackground"
          data-index="1">
          <view class="theme-gradient" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);"></view>
          <view class="theme-info">
            <text class="theme-name-new">æ·±é‚ƒæ˜Ÿç©º</text>
            <view wx:if="{{bgIndex === 1}}" class="theme-check-new">âœ“ ä½¿ç”¨ä¸­</view>
          </view>
        </view>
        <!-- æµ·æ´‹èƒŒæ™¯ -->
        <view
          class="theme-card {{bgIndex === 2 ? 'active' : ''}}"
          bindtap="selectBackground"
          data-index="2">
          <view class="theme-gradient" style="background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);"></view>
          <view class="theme-info">
            <text class="theme-name-new">æ·±æµ·è“è°ƒ</text>
            <view wx:if="{{bgIndex === 2}}" class="theme-check-new">âœ“ ä½¿ç”¨ä¸­</view>
          </view>
        </view>
        <!-- æ£®æ—èƒŒæ™¯ -->
        <view
          class="theme-card {{bgIndex === 3 ? 'active' : ''}}"
          bindtap="selectBackground"
          data-index="3">
          <view class="theme-gradient" style="background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);"></view>
          <view class="theme-info">
            <text class="theme-name-new">ç¿ ç»¿æ£®æ—</text>
            <view wx:if="{{bgIndex === 3}}" class="theme-check-new">âœ“ ä½¿ç”¨ä¸­</view>
          </view>
        </view>
        <!-- è‡ªå®šä¹‰å›¾ç‰‡ -->
        <view
          class="theme-card {{bgIndex === 4 ? 'active' : ''}}"
          bindtap="selectBackground"
          data-index="4">
          <view class="theme-gradient" style="background: rgba(245, 247, 250, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; font-size: 48rpx;">
            ğŸ“·
          </view>
          <view class="theme-info">
            <text class="theme-name-new">è‡ªå®šä¹‰å›¾ç‰‡</text>
            <view wx:if="{{bgIndex === 4}}" class="theme-check-new">âœ“ ä½¿ç”¨ä¸­</view>
          </view>
        </view>
      </view>
      <button class="theme-close-btn" bindtap="hideBgSelector">å…³é—­</button>
    </view>
  </view>

  <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰ -->
  <view class="debug-panel" wx:if="{{planData}}">
    <view class="debug-title">ğŸ” è°ƒè¯•ä¿¡æ¯</view>
    <view class="debug-item">é€‰æ‹©: {{cities[cityIndex]}} {{days[dayIndex]}}å¤© {{intents[intentIndex]}}</view>
    <view class="debug-item">ç”Ÿæˆ: {{planData.days.length}}å¤©è¡Œç¨‹ï¼Œæ€»è´¹ç”¨Â¥{{planData.total_cost}}</view>
    <view class="debug-item">æ´»åŠ¨åˆ†å¸ƒ:
      <text wx:for="{{planData.days}}" wx:key="day">Day{{item.day}}({{item.activities.length}}ä¸ª) </text>
    </view>
    <view class="debug-item" wx:if="{{blocks.length > 0}}">Blocks: {{blocks.length}}ä¸ª | ç¼–è¾‘æ¨¡å¼: {{blockEditMode ? 'å¼€' : 'å…³'}}</view>
  </view>

  <!-- æ‚¬æµ®æ“ä½œæ  (FAB) - ä»…åœ¨ç”Ÿæˆè¡Œç¨‹åæ˜¾ç¤º -->
  <view class="fab-container" wx:if="{{planData && !generatedImagePath}}">
    <!-- ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <view class="fab-btn fab-edit {{blockEditMode ? 'active' : ''}}" bindtap="toggleEditMode">
      <text class="fab-icon">{{blockEditMode ? 'âœ“' : 'âœï¸'}}</text>
      <text class="fab-label">{{blockEditMode ? 'å®Œæˆ' : 'ç¼–è¾‘'}}</text>
    </view>

    <!-- æ·»åŠ æ–‡æœ¬æŒ‰é’® -->
    <view class="fab-btn fab-text" bindtap="onAddTextBlock" wx:if="{{blockEditMode}}">
      <text class="fab-icon">ğŸ“</text>
      <text class="fab-label">æ·»åŠ å¤‡æ³¨</text>
    </view>

    <!-- æ·»åŠ åœ°ç‚¹æŒ‰é’® -->
    <view class="fab-btn fab-poi" bindtap="onAddPoiBlock" wx:if="{{blockEditMode}}">
      <text class="fab-icon">ğŸ“</text>
      <text class="fab-label">æ·»åŠ åœ°ç‚¹</text>
    </view>

    <!-- åˆ†éš”çº¿ -->
    <view class="fab-divider" wx:if="{{blockEditMode}}"></view>

    <!-- åŸæœ‰åŠŸèƒ½æŒ‰é’® -->
    <view class="fab-btn fab-theme" bindtap="showBgSelector">
      <text class="fab-icon">ğŸ¨</text>
      <text class="fab-label">æ¢èƒŒæ™¯</text>
    </view>

    <view class="fab-btn fab-poster" bindtap="generatePoster">
      <text class="fab-icon">ğŸ“¸</text>
      <text class="fab-label">ç”Ÿæˆæµ·æŠ¥</text>
    </view>
  </view>
</view>
