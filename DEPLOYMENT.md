# 部署指南

## 第一步：开通云开发

1. 在微信开发者工具中打开项目
2. 点击"云开发"按钮
3. 开通云开发服务（如果还未开通）
4. 记录云开发环境 ID

## 第二步：创建云数据库

1. 进入云开发控制台
2. 点击"数据库"标签
3. 创建集合 `activities`
4. 设置权限：
   - 所有用户可读
   - 仅创建者可写

## 第三步：导入示例数据

### 方法一：使用控制台导入（推荐）

**重要：必须使用 JSON Lines 格式！**

1. 在云开发控制台的数据库页面
2. 选择 `activities` 集合
3. 点击"导入"
4. 选择项目根目录下的 **`sample_activities_jsonl.json`** 文件
5. 确认导入

**注意**：微信云数据库只支持 JSON Lines 格式（每行一个 JSON 对象），不支持标准 JSON 数组。

### 方法二：手动添加

如果导入失败，可以手动添加数据：

1. 在云开发控制台的数据库页面
2. 选择 `activities` 集合
3. 点击"添加记录"
4. 参考 `sample_activities.json` 文件中的数据格式
5. 手动添加至少 20 条数据

## 第四步：上传云函数

1. 在微信开发者工具中，右键点击 `cloudfunctions/generateCard` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成

## 第五步：测试

1. 编译并运行小程序
2. 选择城市、天数、出行目的
3. 点击"3 秒出卡"按钮
4. 查看生成的行程卡片

## 注意事项

### 云函数权限

确保云函数有以下权限：

- 数据库读取权限
- 云存储上传权限
- 小程序码生成权限（openapi.wxacode.getUnlimited）

### 云存储

云函数会自动在云存储中创建 `cards/` 目录存储生成的卡片。

### 环境变量

云函数使用 `cloud.DYNAMIC_CURRENT_ENV` 自动识别当前环境，无需手动配置。

## 常见问题

### Q: 云函数调用失败？

A: 检查云函数是否已成功上传，查看云函数日志排查错误。

### Q: 数据库查询为空？

A: 确认数据已正确导入，tags 字段格式正确（数组类型）。

### Q: 图片无法显示？

A: 当前版本生成的是文本文件，后续需要实现真正的图片生成功能。

## 下一步优化

1. 实现真正的图片生成（使用 Canvas 或图片处理库）
2. 添加小程序码到卡片图
3. 优化规则引擎算法
4. 添加更多城市和活动数据
5. 实现用户收藏和历史记录功能
